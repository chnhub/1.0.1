!function(){var e,t,n={},a=sogouExplorer.extension.connect();!function(){if(null==localStorage.getItem("equip")||"undefined"==localStorage.getItem("equip"))window.close();else{t=JSON.parse(localStorage.getItem("equip"));for(var e in t){var n=t[e].name.replace(/\</g,"&lt;").replace(/\>/g,"&gt;"),a='<li class="eqlists-li" eid="'+t[e].uuid+'" eqname="'+n+'"><label><div class="eq-item eq-item-bg"><div class="eq-look"><span class="item-chose-icon"></span><span class="sendUrl-loading" style="display: none"></span></div></div><div class="eq-radio"><input type="radio" name="eq-name"><span class="eq-name" title="'+n+'">'+n+'</span></div></label><span class="del" title="解绑设备"></span></li>';$(a).insertBefore("#addEqItem")}}}(),sogouExplorer.command.userInfo.getUserID(function(t,n){r({hid:e=t,page:"eqlist"})});null==localStorage.getItem("lastSentEq")||"undefined"==localStorage.getItem("lastSentEq")?o(0):o(),$(".eq-item").length>2&&$(".eqlists-wrap").addClass("scroller"),window.onbeforeunload=function(){},$(':radio[name="eq-name"]').click(function(){o($(this).parents(".eqlists-li").index())}),$(".del").each(function(t,n){$(n).on("click",function(){var n=$(this).parents(".eqlists-li"),i=n.hasClass("eq-selected");if(confirm("确定将PC和"+n.find(".eq-name").text()+"解绑吗？")){var s=n.attr("eid");$.ajax({type:"GET",url:"http://sync.mse.sogou.com/delcouple",data:"hid="+e+"&uuid="+s,success:function(e){JSON.parse(e).state||n.fadeOut(400,function(){n.remove(),function(e){var t=JSON.parse(localStorage.equip),n=0,a=!1;t.some(function(t,o){return e in t&&(n=o,a=!0),a}),t.splice(n,1),sogouExplorer.extension.sendRequest({cmd:"equipCount",count:t.length},function(){}),localStorage.setItem("equip",JSON.stringify(t))}(s),0==$(".del").length?(localStorage.clear(),localStorage.setItem("isInstalled","1"),a.postMessage({cmd:"updateEqTips",eqName:"nobinding"}),window.close()):i&&o(0==t?0:t-1)})},error:function(){alert("服务器异常，请稍后重试！")}})}})}),$(".eqlists-wrap").on("click",".add-eq",function(){a.postMessage({cmd:"showQR"})}),$("#sendUrl").on("click",function(){r({hid:e,btn:"sendurl"}),$("input[type=radio]:checked").length?sogouExplorer.tabs.getSelected(function(t){var n,a=$(':radio[name="eq-name"]:checked').parents("li"),o=a.attr("eid"),c=a.attr("eqname"),d=a.find(".sendUrl-loading"),u=$("#overlay"),p=$(".upl-wrap"),f=$(".rec-confirm"),m=t.title.replace(/\"/g,'\\"'),g=t.url,h="发送失败";/^se/gi.test(t.url)&&(g="http://123.sogou.com/",m="搜狗网址导航"),n='{"hid":"'+e+'","uuid":"'+o+'","data":"'+g+'","title":"'+m+'"}',$.ajax({type:"POST",url:"http://sync.mse.sogou.com/sendurl",processData:!1,data:n,beforeSend:function(){$("#sendFile").val(""),d.show(),$(".op-btn-wrap input").attr("disabled","disabled"),p.hide()},success:function(t){1===JSON.parse(t).ret?("no binding"===t.errmsg&&(h="该设备已解绑，无法发送"),d.delay(1e3).fadeOut(),i("warn",h)):(d.delay(1e3).fadeOut(function(){localStorage.getItem("hasReceived")?(console.log("sendurl succ tips"),i("succ","已成功发送到 "+c)):(s(),f.show(),l("setMark"),u.fadeIn(400))}),r({hid:e,uuid:o,url:g,title:m,send_t:new Date})),console.log("success")},error:function(e){console.log(e),d.delay(1e3).fadeOut(),i("warn","发送失败")}})}):alert("亲，请选择一个设备")}),$("#sendFile").change(function(){for(var t=0,a=[],o=[],c=0,d=$(this).get(0).files.length;c<d;c++)t+=$(this).get(0).files[c].size,a[c]=$(this).get(0).files[c].name,o[c]=$(this).get(0).files[c].size;if(t<15728640){var u=$(':radio[name="eq-name"]:checked').parents("li"),p=u.attr("eid"),f=u.attr("eqname"),m=$("#overlay"),g=$(".upl-wrap"),h=$(".rec-confirm"),q=$(".pro-bar"),v=$(".pro-percent");$('<input type="hidden" name="hid">').val(e).appendTo("#uploadForm"),$('<input type="hidden" name="uuid">').val(p).appendTo("#uploadForm"),n={type:"POST",url:"http://sync.mse.sogou.com/sendfile",beforeSend:function(e){$(".pro-cancel").on("click",function(t){e.abort(),$("#sendFile").val(""),$("#overlay").fadeOut(0)}),$(".eqn").html(f),q.width("0"),m.fadeIn(400)},uploadProgress:function(e,t,n,a,o){q.animate({width:2.33*a},200,function(){v.html(a+"%"),100==a&&($("#sendFile").val(""),$("input").remove(":hidden"))})},success:function(t){if($("#sendFile").val(""),$("input").remove(":hidden"),$(".pro-cancel").off("click"),$(".op-btn-wrap input").attr("disabled","disabled"),0===JSON.parse(t).ret){localStorage.getItem("hasReceived")?m.delay(400).fadeOut(400,function(){i("succ","已成功发送到"+f)}):g.delay(600).fadeOut(400,function(){s(),h.show(),l("setMark")});for(var n=0,c=a.length;n<c;n++)r({hid:e,uuid:p,filename:a[n],filesize:o[n],send_t:new Date})}else m.delay(400).fadeOut(400,function(){i("warn","发送失败，请稍后重试!")})},error:function(e){$("#sendFile").val(""),$("input").remove(":hidden"),$(".pro-cancel").off("click"),$(".op-btn-wrap input").attr("disabled","disabled"),m.delay(1e3).fadeOut(400,function(){"abort"==e.statusText?i("succ","  已取消发送!"):i("warn","网络异常，请稍后重试!")})},complete:function(){h.hide(),g.show()}},$("#uploadForm").ajaxForm(n),$("#uploadForm").submit()}else $(this).val(""),$(".op-btn-wrap input").attr("disabled","disabled"),i("warn","目前仅提供15M以下大小的文件传输")}),$(".sogou-btns-rec").click(function(){r({hid:e,btn:"hasreceived"}),localStorage.setItem("hasReceived",1),setTimeout(function(){$("#overlay").fadeOut(400,function(){l("eraseMark"),i("succ","已成功发送")})},50)}),$(".sogou-btns-norec").click(function(){r({hid:e,btn:"notreceived"}),setTimeout(function(){$("#overlay").fadeOut(400,function(){l("eraseMark"),i("succ","已成功发送")})},50)}),$("#sendFile").on("click",function(){r({hid:e,btn:"sendfile"})});function o(e){var t,n=$(".eqlists-li");null==e&&(e=JSON.parse(localStorage.getItem("lastSentEq")).idx,t=JSON.parse(localStorage.getItem("lastSentEq")).eqid),t=n.eq(e).attr("eid"),eqname=n.eq(e).attr("eqname"),n.removeClass("eq-selected"),n.eq(e).addClass("eq-selected").find(':radio[name="eq-name"]').attr("checked","checked"),$(".tips-cureq-name").text(eqname),localStorage.setItem("lastSentEq",'{"idx":"'+e+'","eqid":"'+t+'","eqname":"'+eqname+'"}'),a.postMessage({cmd:"updateEqTips",eqName:eqname})}function i(e,t){if(localStorage.getItem("hasReceived")){switch(e){case"succ":console.log("succ"),$(".upload-file-warn").addClass("upload-file-succ");break;case"warn":console.log("warn"),$(".upload-file-warn").removeClass("upload-file-succ")}$(".warn-con").text(t),$(".upload-file-warn").delay(400).slideDown(1e3).delay(800).slideToggle(400,function(){$(".op-btn-wrap input").removeAttr("disabled")})}else $(".op-btn-wrap input").removeAttr("disabled")}function s(){for(var e=sogouExplorer.extension.getViews(),t=0,n=e.length;t<n;t++)"tips"===e[t].name&&e[t].close()}function l(e){switch(e){case"setMark":localStorage.setItem("markConfirm",1);break;case"eraseMark":localStorage.setItem("markConfirm",0)}}function r(e){var t;if(e){var n="string"==typeof e?JSON.parse(e):e,a=[];for(var o in n)a.push(o+"="+n[o]);t=a.join("&")}(new Image).src="http://ping.ie.sogou.com/feichuan.gif?"+t}sogouExplorer.extension.onConnect.addListener(function(e){e.onMessage.addListener(function(e){"sendUrl"===e.cmd&&$("#sendUrl").trigger("click"),"autoSend"===e.cmd&&$("#sendUrl").trigger("click")})}),sogouExplorer.extension.onRequest.addListener(function(e,t,n){switch(e.cmd){case"confirmHide":$(".sogou-btns-norec").trigger("click");break;case"autoSend":$("#sendUrl").trigger("click")}})}();